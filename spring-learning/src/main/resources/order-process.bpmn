<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
                  id="Definitions_1"
                  targetNamespace="http://bpmn.io/schema/bpmn">

  <bpmn:process id="OrderSagaProcess" name="Order Saga Process" isExecutable="true">

    <bpmn:startEvent id="StartEvent" name="Start"/>

    <bpmn:sequenceFlow id="flow1" sourceRef="StartEvent" targetRef="CreateOrder"/>

    <bpmn:serviceTask id="CreateOrder" name="Create Order" camunda:class="com.example.spring_learning.payment.Order"/>
    <bpmn:sequenceFlow id="flow2" sourceRef="CreateOrder" targetRef="ReserveInventory"/>

    <bpmn:serviceTask id="ReserveInventory" name="Reserve Inventory" camunda:class="com.example.spring_learning.payment.Inventory"/>
    <bpmn:sequenceFlow id="flow3" sourceRef="ReserveInventory" targetRef="CheckInventorySuccess"/>

    <bpmn:exclusiveGateway id="CheckInventorySuccess" name="Inventory Success?"/>

    <!-- Success Path -->
    <bpmn:sequenceFlow id="flow4" sourceRef="CheckInventorySuccess" targetRef="ProcessPayment">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression"><![CDATA[${inventorySuccess}]]></bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:serviceTask id="ProcessPayment" name="Process Payment" camunda:class="com.example.spring_learning.payment.Payment"/>
    <bpmn:sequenceFlow id="flow5" sourceRef="ProcessPayment" targetRef="SuccessEnd"/>
    <bpmn:endEvent id="SuccessEnd" name="Success"/>

    <!-- Failure Path -->
    <bpmn:sequenceFlow id="flow6" sourceRef="CheckInventorySuccess" targetRef="CancelInventory">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression"><![CDATA[${!inventorySuccess}]]></bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:serviceTask id="CancelInventory" name="Cancel Inventory" camunda:class="com.example.spring_learning.payment.Order"/>
    <bpmn:sequenceFlow id="flow7" sourceRef="CancelInventory" targetRef="CancelOrder"/>

    <bpmn:serviceTask id="CancelOrder" name="Cancel Order" camunda:class="com.example.spring_learning.payment.Order"/>
    <bpmn:sequenceFlow id="flow8" sourceRef="CancelOrder" targetRef="FailureEnd"/>
    <bpmn:endEvent id="FailureEnd" name="Failure"/>

  </bpmn:process>

  <!-- Optional: Diagram (only if you want layout support in Camunda Modeler) -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_OrderSaga">
    <bpmndi:BPMNPlane id="BPMNPlane_OrderSaga" bpmnElement="OrderSagaProcess"/>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
